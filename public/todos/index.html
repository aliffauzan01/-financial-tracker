<!DOCTYPE html>
<html>
<head>
    <title>Todos</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #debug { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>üìù DAFTAR TODO</h1>
    
    <div id="userInfo">Memuat informasi user...</div>
    
    <div id="debug">
        <strong>Debug Info:</strong>
        <div id="debugContent"></div>
    </div>
    
    <h2>‚ûï Tambah Todo Baru</h2>
    <form id="todoForm">
        <input type="text" id="todoText" placeholder="Masukkan todo baru..." 
               style="padding: 8px; width: 300px;" required>
        <button type="submit" style="padding: 8px 16px;">Tambah</button>
    </form>
    
    <h2>üìã Daftar Todo Anda:</h2>
    <ul id="todoList">
        <li>Memuat todos...</li>
    </ul>
    
    <div id="message"></div>
    
    <p>
        <button onclick="logout()" style="padding: 8px 16px;">Logout</button>
        <a href="/" style="margin-left: 10px;">üè† Home</a>
    </p>
    
    <script>
        // Debug
        function debug(msg) {
            const debugEl = document.getElementById('debugContent');
            const time = new Date().toLocaleTimeString();
            debugEl.innerHTML += `<div>[${time}] ${msg}</div>`;
        }
        
        // Cek login
        async function checkAuth() {
            debug('Checking authentication...');
            
            try {
                const response = await fetch('/api/me');
                debug(`API Response status: ${response.status}`);
                
                const data = await response.json();
                debug(`API Response: ${JSON.stringify(data)}`);
                
                if (data.success) {
                    document.getElementById('userInfo').innerHTML = 
                        `<strong>üëã Halo, ${data.user.username}!</strong>`;
                    debug('‚úÖ Authentication successful');
                    return data.user;
                } else {
                    debug('‚ùå Not authenticated');
                    window.location.href = '/login';
                    return null;
                }
            } catch (error) {
                debug(`‚ùå Auth error: ${error.message}`);
                window.location.href = '/login';
                return null;
            }
        }
        
        // Load todos
        async function loadTodos() {
            debug('Loading todos...');
            
            try {
                const response = await fetch('/api/todos');
                debug(`Todos API status: ${response.status}`);
                
                const data = await response.json();
                debug(`Todos data: ${JSON.stringify(data)}`);
                
                const todoList = document.getElementById('todoList');
                
                if (data.success) {
                    if (data.todos && data.todos.length > 0) {
                        todoList.innerHTML = '';
                        data.todos.forEach((todo, index) => {
                            const li = document.createElement('li');
                            li.innerHTML = `<strong>${index + 1}.</strong> ${todo.text}`;
                            todoList.appendChild(li);
                        });
                        debug(`‚úÖ Loaded ${data.todos.length} todos`);
                    } else {
                        todoList.innerHTML = '<li>üì≠ Belum ada todo. Tambahkan yang pertama!</li>';
                        debug('‚ÑπÔ∏è No todos found');
                    }
                } else {
                    todoList.innerHTML = `<li class="error">‚ùå Error: ${data.message}</li>`;
                    debug(`‚ùå Error: ${data.message}`);
                }
            } catch (error) {
                debug(`‚ùå Load error: ${error.message}`);
                document.getElementById('todoList').innerHTML = 
                    `<li class="error">‚ùå Error: ${error.message}</li>`;
            }
        }
        
        // Add todo
        document.getElementById('todoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const text = document.getElementById('todoText').value.trim();
            const messageEl = document.getElementById('message');
            
            debug(`Attempting to add todo: "${text}"`);
            
            if (!text) {
                messageEl.textContent = '‚ùå Todo tidak boleh kosong';
                messageEl.className = 'error';
                return;
            }
            
            messageEl.textContent = '‚è≥ Menambahkan todo...';
            messageEl.className = '';
            
            try {
                const response = await fetch('/api/todos', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ text: text })
                });
                
                debug(`Add todo API status: ${response.status}`);
                
                const data = await response.json();
                debug(`Add todo response: ${JSON.stringify(data)}`);
                
                if (data.success) {
                    messageEl.textContent = '‚úÖ Todo berhasil ditambahkan!';
                    messageEl.className = 'success';
                    
                    // Clear input
                    document.getElementById('todoText').value = '';
                    
                    // Reload todos
                    setTimeout(loadTodos, 500);
                    
                    debug('‚úÖ Todo added successfully');
                } else {
                    messageEl.textContent = `‚ùå ${data.message}`;
                    messageEl.className = 'error';
                    debug(`‚ùå Failed: ${data.message}`);
                }
            } catch (error) {
                messageEl.textContent = `‚ùå Error: ${error.message}`;
                messageEl.className = 'error';
                debug(`‚ùå Error: ${error.message}`);
            }
        });
        
        // Logout
        async function logout() {
            debug('Logging out...');
            
            try {
                await fetch('/api/logout', { method: 'POST' });
                debug('‚úÖ Logout successful');
                window.location.href = '/login';
            } catch (error) {
                debug(`‚ùå Logout error: ${error.message}`);
                window.location.href = '/login';
            }
        }
        
        // Initialize
        window.addEventListener('load', async () => {
            debug('Page loaded');
            const user = await checkAuth();
            if (user) {
                await loadTodos();
                debug('‚úÖ Page initialized');
            }
        });
    </script>
</body>
</html>